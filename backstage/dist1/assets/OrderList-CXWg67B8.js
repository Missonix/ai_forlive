import{a as e,_ as a}from"./_plugin-vue_export-helper-B34n5pss.js";import{a as l,c as r}from"./element-plus-4dk9whhS.js";import{x as t,r as u,h as d,y as o,P as s,H as n,ag as i,z as p,A as c,I as v,L as m,aq as _,G as g,M as f,J as h,O as y,a6 as w}from"./vue-vendor-B0tYOcBV.js";const b="/api",V={createOrder:a=>e.post(`${b}/orders`,a),updateOrder:(a,l)=>e.patch(`${b}/orders/${a}`,l),getAllOrders:(a=1,l=10)=>e.get(`${b}/orders?page=${a}&page_size=${l}`),getOrder:a=>e.get(`${b}/orders/${a}`),searchOrder:a=>e.post(`${b}/orders/search`,a),deleteOrder:a=>e.delete(`${b}/orders/${a}`),generateEntitlement:a=>e.get(`${b}/user_entitlements/generate/${a}`),uploadOrders(a){const l=new FormData;return l.append("file",a),e.post(`${b}/orders/upload`,l,{headers:{"Content-Type":"multipart/form-data"}})}},k={class:"order-list"},C={class:"card-header"},z={class:"header-buttons"},D={class:"search-bar"},U={class:"pagination"},$={class:"dialog-footer"},x={class:"upload-result"},O={key:0,class:"error-messages"},Y={class:"dialog-footer"},I={class:"generate-result"},M={key:0,class:"error-messages"},H={class:"dialog-footer"},S={class:"pagination"},q={class:"pagination"},E="/api",P=a(t({__name:"OrderList",setup(a){const t=u([]),b=u(!1),P=u(!1),j=u("add"),L=u(""),A=u(1),F=u(10),T=u(0),B=u({order_id:"",phone:"",course_id:"",purchase_time:"",is_refund:""}),G=u(),J=u({order_id:"",phone:"",course_name:"",purchase_time:"",is_refund:"无"}),R={order_id:[{required:!0,message:"请输入订单ID",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}],course_name:[{required:!0,message:"请输入课程名称",trigger:"blur"}],purchase_time:[{required:!0,message:"请选择购买时间",trigger:"change"}],is_refund:[{required:!0,message:"请选择退款状态",trigger:"change"}]},K=u(!1),N=u(!1),Q=u({total:0,success:0,error:0,error_messages:[]}),W=u(!1),X=u(!1),Z=u({total:0,success:0,error:0,error_messages:[]}),ee=u(!1),ae=u([]),le=u(!1),re=u(1),te=u(10),ue=u(0),de=u(!1),oe=u([]),se=u(!1),ne=u(1),ie=u(10),pe=u(0),ce=async()=>{try{b.value=!0;const e=await V.getAllOrders(A.value,F.value);t.value=e.data.data.items,T.value=e.data.data.total}catch(e){l.error("获取订单列表失败")}finally{b.value=!1}},ve=async()=>{try{b.value=!0;const e=Object.fromEntries(Object.entries(B.value).filter((([,e])=>""!==e&&null!=e))),a=await V.searchOrder(e);t.value=a.data.data.items,T.value=a.data.data.total}catch(e){l.error("搜索订单失败")}finally{b.value=!1}},me=()=>{B.value={order_id:"",phone:"",course_id:"",purchase_time:"",is_refund:""},A.value=1,ce()},_e=e=>{A.value=e,ce()},ge=e=>{F.value=e,A.value=1,ce()},fe=()=>{j.value="add",J.value={order_id:"",phone:"",course_name:"",purchase_time:"",is_refund:"无"},P.value=!0},he=async()=>{G.value&&await G.value.validate((async e=>{if(e)try{"add"===j.value?(await V.createOrder(J.value),l.success("创建成功")):(await V.updateOrder(L.value,J.value),l.success("更新成功")),P.value=!1,await ce()}catch(a){l.error("add"===j.value?"创建失败":"更新失败")}}))},ye=e=>{if(!("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e.type))return l.error("只能上传 xlsx 格式的文件！"),!1;return e.size/1024/1024<10?(K.value=!0,!0):(l.error("文件大小不能超过 10MB!"),!1)},we=e=>{},be=e=>{K.value=!1,200===e.code?(Q.value=e.data||{total:0,success:0,error:0,error_messages:[]},N.value=!0,l.success(e.message||"订单上传成功")):l.error(e.message||"上传失败")},Ve=e=>{K.value=!1,l.error(e.message||"上传失败，请重试")},ke=async()=>{N.value=!1,await ce()},Ce=async a=>{const{file:l,onSuccess:r,onError:t,onProgress:u}=a,d=new FormData;d.append("file",l);try{r((await e.post(`${E}/orders/upload`,d,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:e=>{e.total&&u({percent:Math.round(100*e.loaded/e.total)})}})).data)}catch(o){t({status:500,method:"post",url:`${E}/orders/upload`,name:"UploadError",message:o instanceof Error?o.message:"上传失败"})}},ze=async()=>{try{W.value=!0;const a=await e.get(`${E}/user_entitlements/batch_generate`);200===a.data.code?(Z.value=a.data.data,X.value=!0,l.success(a.data.message)):l.error(a.data.message||"批量生成失败")}catch(a){l.error("批量生成失败，请重试")}finally{W.value=!1}},De=async()=>{X.value=!1,await ce()},Ue=async()=>{ee.value=!0,await $e()},$e=async()=>{try{le.value=!0;const a=await e.get(`${E}/upload_error_orders`,{params:{page:re.value,page_size:te.value}});200===a.data.code?(ae.value=a.data.data.items,ue.value=a.data.data.total):l.error(a.data.message||"获取上传失败记录失败")}catch(a){l.error("获取上传失败记录失败")}finally{le.value=!1}},xe=e=>{te.value=e,re.value=1,$e()},Oe=e=>{re.value=e,$e()},Ye=async()=>{de.value=!0,await Ie()},Ie=async()=>{try{se.value=!0;const a=await e.get(`${E}/batch_generate_errors`,{params:{page:ne.value,page_size:ie.value}});200===a.data.code?(oe.value=a.data.data.items,pe.value=a.data.data.total):l.error(a.data.message||"获取生成失败记录失败")}catch(a){l.error("获取生成失败记录失败")}finally{se.value=!1}},Me=e=>{ie.value=e,ne.value=1,Ie()},He=e=>{ne.value=e,Ie()};return d((async()=>{await ce()})),(e,a)=>{const u=i("el-button"),d=i("el-upload"),$e=i("el-input"),Ie=i("el-form-item"),Se=i("el-date-picker"),qe=i("el-option"),Ee=i("el-select"),Pe=i("el-form"),je=i("el-table-column"),Le=i("el-tag"),Ae=i("el-button-group"),Fe=i("el-table"),Te=i("el-pagination"),Be=i("el-card"),Ge=i("el-dialog"),Je=_("loading");return p(),o("div",k,[s(Be,null,{header:n((()=>[c("div",C,[a[29]||(a[29]=c("span",null,"订单管理",-1)),c("div",z,[s(d,{class:"upload-button",action:`${E}/orders/upload`,"show-file-list":!1,"before-upload":ye,"on-success":be,"on-error":Ve,"on-progress":we,"http-request":Ce,accept:".xlsx"},{default:n((()=>[s(u,{type:"primary",loading:K.value},{default:n((()=>a[24]||(a[24]=[m("批量上传")]))),_:1},8,["loading"])])),_:1},8,["action"]),s(u,{type:"success",onClick:ze,loading:W.value},{default:n((()=>a[25]||(a[25]=[m("批量生成权益")]))),_:1},8,["loading"]),s(u,{type:"warning",onClick:Ue},{default:n((()=>a[26]||(a[26]=[m("查看上传失败记录")]))),_:1}),s(u,{type:"danger",onClick:Ye},{default:n((()=>a[27]||(a[27]=[m("查看生成失败记录")]))),_:1}),s(u,{type:"primary",onClick:fe},{default:n((()=>a[28]||(a[28]=[m("新增订单")]))),_:1})])])])),default:n((()=>[c("div",D,[s(Pe,{inline:!0,model:B.value,class:"search-form"},{default:n((()=>[s(Ie,{label:"订单ID"},{default:n((()=>[s($e,{modelValue:B.value.order_id,"onUpdate:modelValue":a[0]||(a[0]=e=>B.value.order_id=e),placeholder:"请输入订单ID",clearable:""},null,8,["modelValue"])])),_:1}),s(Ie,{label:"手机号"},{default:n((()=>[s($e,{modelValue:B.value.phone,"onUpdate:modelValue":a[1]||(a[1]=e=>B.value.phone=e),placeholder:"请输入手机号",clearable:""},null,8,["modelValue"])])),_:1}),s(Ie,{label:"课程ID"},{default:n((()=>[s($e,{modelValue:B.value.course_id,"onUpdate:modelValue":a[2]||(a[2]=e=>B.value.course_id=e),placeholder:"请输入课程ID",clearable:""},null,8,["modelValue"])])),_:1}),s(Ie,{label:"购买时间"},{default:n((()=>[s(Se,{modelValue:B.value.purchase_time,"onUpdate:modelValue":a[3]||(a[3]=e=>B.value.purchase_time=e),type:"datetime",placeholder:"选择购买时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",clearable:""},null,8,["modelValue"])])),_:1}),s(Ie,{label:"退款状态"},{default:n((()=>[s(Ee,{modelValue:B.value.is_refund,"onUpdate:modelValue":a[4]||(a[4]=e=>B.value.is_refund=e),placeholder:"请选择退款状态",clearable:""},{default:n((()=>[s(qe,{label:"无",value:"无"}),s(qe,{label:"已退款",value:"已退款"})])),_:1},8,["modelValue"])])),_:1}),s(Ie,null,{default:n((()=>[s(u,{type:"primary",onClick:ve},{default:n((()=>a[30]||(a[30]=[m("搜索")]))),_:1}),s(u,{onClick:me},{default:n((()=>a[31]||(a[31]=[m("重置")]))),_:1})])),_:1})])),_:1},8,["model"])]),v((p(),g(Fe,{data:t.value,style:{width:"100%"}},{default:n((()=>[s(je,{prop:"order_id",label:"订单ID",width:"220"}),s(je,{prop:"phone",label:"手机号",width:"120"}),s(je,{prop:"course_id",label:"课程ID",width:"220"}),s(je,{prop:"purchase_time",label:"购买时间",width:"180"}),s(je,{prop:"is_refund",label:"退款状态",width:"100"},{default:n((({row:e})=>[s(Le,{type:"已退款"===e.is_refund?"danger":"success"},{default:n((()=>[m(f(e.is_refund),1)])),_:2},1032,["type"])])),_:1}),s(je,{prop:"is_generate",label:"权益状态",width:"100"},{default:n((({row:e})=>[s(Le,{type:e.is_generate?"success":"info"},{default:n((()=>[m(f(e.is_generate?"已生成":"未生成"),1)])),_:2},1032,["type"])])),_:1}),s(je,{label:"操作",fixed:"right",width:"250"},{default:n((({row:e})=>[s(Ae,null,{default:n((()=>[s(u,{type:"primary",link:"",onClick:a=>(e=>{j.value="edit",L.value=e.order_id,J.value={order_id:e.order_id,phone:e.phone,course_name:"",purchase_time:e.purchase_time,is_refund:e.is_refund?"已退款":"无"},P.value=!0})(e)},{default:n((()=>a[32]||(a[32]=[m("编辑")]))),_:2},1032,["onClick"]),s(u,{type:"danger",link:"",onClick:a=>(async e=>{try{await r.confirm("确定要删除该订单吗？","提示",{type:"warning"}),await V.deleteOrder(e.order_id),l.success("删除成功"),await ce()}catch(a){"cancel"!==a&&l.error("删除失败")}})(e)},{default:n((()=>a[33]||(a[33]=[m("删除")]))),_:2},1032,["onClick"]),s(u,{type:"success",link:"",disabled:e.is_generate,onClick:a=>(async e=>{try{await r.confirm("确定要生成该订单的用户权益吗？","提示",{type:"warning"});const a=await V.generateEntitlement(e.order_id);200===a.data.code?(l.success("用户权益生成成功"),await ce()):l.error(a.data.message||"生成失败")}catch(a){"cancel"!==a&&l.error("生成用户权益失败")}})(e)},{default:n((()=>a[34]||(a[34]=[m(" 生成权益 ")]))),_:2},1032,["disabled","onClick"])])),_:2},1024)])),_:1})])),_:1},8,["data"])),[[Je,b.value]]),c("div",U,[s(Te,{"current-page":A.value,"onUpdate:currentPage":a[5]||(a[5]=e=>A.value=e),"page-size":F.value,"onUpdate:pageSize":a[6]||(a[6]=e=>F.value=e),"page-sizes":[10,20,50,100],total:T.value,layout:"total, sizes, prev, pager, next",onSizeChange:ge,onCurrentChange:_e},null,8,["current-page","page-size","total"])])])),_:1}),s(Ge,{modelValue:P.value,"onUpdate:modelValue":a[13]||(a[13]=e=>P.value=e),title:"add"===j.value?"新增订单":"编辑订单",width:"500px"},{footer:n((()=>[c("span",$,[s(u,{onClick:a[12]||(a[12]=e=>P.value=!1)},{default:n((()=>a[35]||(a[35]=[m("取消")]))),_:1}),s(u,{type:"primary",onClick:he},{default:n((()=>a[36]||(a[36]=[m("确定")]))),_:1})])])),default:n((()=>[s(Pe,{ref_key:"formRef",ref:G,model:J.value,rules:R,"label-width":"100px"},{default:n((()=>["add"===j.value?(p(),g(Ie,{key:0,label:"订单ID",prop:"order_id"},{default:n((()=>[s($e,{modelValue:J.value.order_id,"onUpdate:modelValue":a[7]||(a[7]=e=>J.value.order_id=e),placeholder:"请输入订单ID"},null,8,["modelValue"])])),_:1})):h("",!0),"add"===j.value?(p(),g(Ie,{key:1,label:"手机号",prop:"phone"},{default:n((()=>[s($e,{modelValue:J.value.phone,"onUpdate:modelValue":a[8]||(a[8]=e=>J.value.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1})):h("",!0),"add"===j.value?(p(),g(Ie,{key:2,label:"课程名称",prop:"course_name"},{default:n((()=>[s($e,{modelValue:J.value.course_name,"onUpdate:modelValue":a[9]||(a[9]=e=>J.value.course_name=e),placeholder:"请输入课程名称"},null,8,["modelValue"])])),_:1})):h("",!0),"add"===j.value?(p(),g(Ie,{key:3,label:"购买时间",prop:"purchase_time"},{default:n((()=>[s(Se,{modelValue:J.value.purchase_time,"onUpdate:modelValue":a[10]||(a[10]=e=>J.value.purchase_time=e),type:"datetime",placeholder:"选择购买时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])])),_:1})):h("",!0),s(Ie,{label:"退款状态",prop:"is_refund"},{default:n((()=>[s(Ee,{modelValue:J.value.is_refund,"onUpdate:modelValue":a[11]||(a[11]=e=>J.value.is_refund=e),placeholder:"请选择退款状态"},{default:n((()=>[s(qe,{label:"无",value:"无"}),s(qe,{label:"已退款",value:"已退款"})])),_:1},8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue","title"]),s(Ge,{modelValue:N.value,"onUpdate:modelValue":a[15]||(a[15]=e=>N.value=e),title:"上传结果",width:"500px"},{footer:n((()=>[c("span",Y,[s(u,{onClick:a[14]||(a[14]=e=>N.value=!1)},{default:n((()=>a[38]||(a[38]=[m("关闭")]))),_:1}),s(u,{type:"primary",onClick:ke},{default:n((()=>a[39]||(a[39]=[m("确定")]))),_:1})])])),default:n((()=>[c("div",x,[c("p",null,"总数据："+f(Q.value.total)+" 条",1),c("p",null,"成功："+f(Q.value.success)+" 条",1),c("p",null,"失败："+f(Q.value.error)+" 条",1),Q.value.error>0?(p(),o("div",O,[a[37]||(a[37]=c("p",null,"错误详情：",-1)),c("ul",null,[(p(!0),o(y,null,w(Q.value.error_messages,((e,a)=>(p(),o("li",{key:a},f(e),1)))),128))])])):h("",!0)])])),_:1},8,["modelValue"]),s(Ge,{modelValue:X.value,"onUpdate:modelValue":a[17]||(a[17]=e=>X.value=e),title:"批量生成结果",width:"500px"},{footer:n((()=>[c("span",H,[s(u,{onClick:a[16]||(a[16]=e=>X.value=!1)},{default:n((()=>a[41]||(a[41]=[m("关闭")]))),_:1}),s(u,{type:"primary",onClick:De},{default:n((()=>a[42]||(a[42]=[m("确定")]))),_:1})])])),default:n((()=>[c("div",I,[c("p",null,"总数据："+f(Z.value.total)+" 条",1),c("p",null,"成功："+f(Z.value.success)+" 条",1),c("p",null,"失败："+f(Z.value.error)+" 条",1),Z.value.error>0?(p(),o("div",M,[a[40]||(a[40]=c("p",null,"错误详情：",-1)),c("ul",null,[(p(!0),o(y,null,w(Z.value.error_messages,((e,a)=>(p(),o("li",{key:a},f(e),1)))),128))])])):h("",!0)])])),_:1},8,["modelValue"]),s(Ge,{modelValue:ee.value,"onUpdate:modelValue":a[20]||(a[20]=e=>ee.value=e),title:"上传失败记录",width:"800px"},{default:n((()=>[v((p(),g(Fe,{data:ae.value,style:{width:"100%"}},{default:n((()=>[s(je,{prop:"order_id",label:"订单ID",width:"220"}),s(je,{prop:"error_message",label:"错误信息","min-width":"300"}),s(je,{prop:"created_at",label:"创建时间",width:"180"},{default:n((({row:e})=>[m(f(new Date(e.created_at).toLocaleString()),1)])),_:1})])),_:1},8,["data"])),[[Je,le.value]]),c("div",S,[s(Te,{"current-page":re.value,"onUpdate:currentPage":a[18]||(a[18]=e=>re.value=e),"page-size":te.value,"onUpdate:pageSize":a[19]||(a[19]=e=>te.value=e),"page-sizes":[10,20,50,100],total:ue.value,layout:"total, sizes, prev, pager, next",onSizeChange:xe,onCurrentChange:Oe},null,8,["current-page","page-size","total"])])])),_:1},8,["modelValue"]),s(Ge,{modelValue:de.value,"onUpdate:modelValue":a[23]||(a[23]=e=>de.value=e),title:"生成失败记录",width:"800px"},{default:n((()=>[v((p(),g(Fe,{data:oe.value,style:{width:"100%"}},{default:n((()=>[s(je,{prop:"order_id",label:"订单ID",width:"220"}),s(je,{prop:"error_message",label:"错误信息","min-width":"300"}),s(je,{prop:"created_at",label:"创建时间",width:"180"},{default:n((({row:e})=>[m(f(new Date(e.created_at).toLocaleString()),1)])),_:1})])),_:1},8,["data"])),[[Je,se.value]]),c("div",q,[s(Te,{"current-page":ne.value,"onUpdate:currentPage":a[21]||(a[21]=e=>ne.value=e),"page-size":ie.value,"onUpdate:pageSize":a[22]||(a[22]=e=>ie.value=e),"page-sizes":[10,20,50,100],total:pe.value,layout:"total, sizes, prev, pager, next",onSizeChange:Me,onCurrentChange:He},null,8,["current-page","page-size","total"])])])),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-b3614cb1"]]);export{P as default};

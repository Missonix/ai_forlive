import{e}from"./entitlement-GbjsK_zp.js";import{c as a}from"./course-O-FbVX8K.js";import{p as l}from"./product-DgBplGEn.js";import{a as d,c as t}from"./element-plus-C6e0990v.js";import{x as i,r as u,h as o,y as r,P as _,H as s,ag as c,z as m,A as n,I as p,L as v,aq as y,G as f,J as h,O as b,a6 as V}from"./vue-vendor-B0tYOcBV.js";import{_ as g}from"./_plugin-vue_export-helper-B34n5pss.js";const w={class:"entitlement-list"},k={class:"card-header"},D={class:"search-bar"},U={class:"dialog-footer"},I=g(i({__name:"EntitlementList",setup(i){const g=u([]),I=u([]),x=u([]),C=u(!1),j=u(!1),Y=u("add"),R=u(""),q=u({rule_id:"",course_id:"",course_name:"",ai_product_id:"",product_name:"",daily_limit:void 0,validity_days:void 0,created_at:""}),H=u(),A=u({course_id:"",ai_product_id:"",daily_limit:void 0,validity_days:void 0}),M={course_id:[{required:!0,message:"请选择课程",trigger:"change"}],ai_product_id:[{required:!0,message:"请选择产品",trigger:"change"}],daily_limit:[{required:!0,message:"请输入每日限制",trigger:"change"}],validity_days:[{required:!0,message:"请输入有效期",trigger:"change"}]},O=async()=>{try{C.value=!0;const a=await e.getAllRules();g.value=a.data.data}catch(a){d.error("获取权益规则列表失败")}finally{C.value=!1}},P=async()=>{try{const e=await a.getAllCourses(1,99);I.value=e.data.data.items}catch(e){d.error("获取课程列表失败")}},L=async()=>{try{const e=await l.getAllProducts(1,99);x.value=e.data.data.items}catch(e){d.error("获取产品列表失败")}},z=async()=>{try{C.value=!0;const a=Object.entries(q.value).reduce(((e,[a,l])=>(""!==l&&null!=l&&(e[a]=l),e)),{});if(0===Object.keys(a).length)return void(await O());a.rule_id&&"string"==typeof a.rule_id&&(a.rule_id=a.rule_id.trim());const l=await e.searchRule(a);200===l.data.code?(g.value=l.data.data,0===g.value.length&&d.info("未找到匹配的规则")):d.error(l.data.message||"搜索失败")}catch(a){d.error("搜索权益规则失败")}finally{C.value=!1}},E=()=>{q.value={rule_id:"",course_id:"",course_name:"",ai_product_id:"",product_name:"",daily_limit:void 0,validity_days:void 0,created_at:""},O()},G=()=>{Y.value="add",A.value={course_id:"",ai_product_id:"",daily_limit:void 0,validity_days:void 0},j.value=!0},J=async()=>{H.value&&await H.value.validate((async a=>{if(a)try{if("add"===Y.value)await e.createRule(A.value),d.success("创建成功");else{const a={ai_product_id:A.value.ai_product_id,daily_limit:A.value.daily_limit,validity_days:A.value.validity_days};await e.updateRule(R.value,a),d.success("更新成功")}j.value=!1,await O()}catch(l){d.error("add"===Y.value?"创建失败":"更新失败")}}))};return o((async()=>{await Promise.all([O(),P(),L()])})),(a,l)=>{const i=c("el-button"),u=c("el-input"),o=c("el-form-item"),P=c("el-input-number"),L=c("el-date-picker"),B=c("el-form"),F=c("el-table-column"),K=c("el-button-group"),N=c("el-table"),Q=c("el-card"),S=c("el-option"),T=c("el-select"),W=c("el-dialog"),X=y("loading");return m(),r("div",w,[_(Q,null,{header:s((()=>[n("div",k,[l[15]||(l[15]=n("span",null,"权益规则管理",-1)),_(i,{type:"primary",onClick:G},{default:s((()=>l[14]||(l[14]=[v("新增规则")]))),_:1})])])),default:s((()=>[n("div",D,[_(B,{inline:!0,model:q.value,class:"search-form"},{default:s((()=>[_(o,{label:"规则ID"},{default:s((()=>[_(u,{modelValue:q.value.rule_id,"onUpdate:modelValue":l[0]||(l[0]=e=>q.value.rule_id=e),placeholder:"请输入规则ID",clearable:""},null,8,["modelValue"])])),_:1}),_(o,{label:"课程ID"},{default:s((()=>[_(u,{modelValue:q.value.course_id,"onUpdate:modelValue":l[1]||(l[1]=e=>q.value.course_id=e),placeholder:"请输入课程ID",clearable:""},null,8,["modelValue"])])),_:1}),_(o,{label:"课程名称"},{default:s((()=>[_(u,{modelValue:q.value.course_name,"onUpdate:modelValue":l[2]||(l[2]=e=>q.value.course_name=e),placeholder:"请输入课程名称",clearable:""},null,8,["modelValue"])])),_:1}),_(o,{label:"产品ID"},{default:s((()=>[_(u,{modelValue:q.value.ai_product_id,"onUpdate:modelValue":l[3]||(l[3]=e=>q.value.ai_product_id=e),placeholder:"请输入产品ID",clearable:""},null,8,["modelValue"])])),_:1}),_(o,{label:"产品名称"},{default:s((()=>[_(u,{modelValue:q.value.product_name,"onUpdate:modelValue":l[4]||(l[4]=e=>q.value.product_name=e),placeholder:"请输入产品名称",clearable:""},null,8,["modelValue"])])),_:1}),_(o,{label:"每日限制"},{default:s((()=>[_(P,{modelValue:q.value.daily_limit,"onUpdate:modelValue":l[5]||(l[5]=e=>q.value.daily_limit=e),min:1,max:100,clearable:""},null,8,["modelValue"])])),_:1}),_(o,{label:"有效期"},{default:s((()=>[_(P,{modelValue:q.value.validity_days,"onUpdate:modelValue":l[6]||(l[6]=e=>q.value.validity_days=e),min:1,max:365,clearable:""},null,8,["modelValue"])])),_:1}),_(o,{label:"创建时间"},{default:s((()=>[_(L,{modelValue:q.value.created_at,"onUpdate:modelValue":l[7]||(l[7]=e=>q.value.created_at=e),type:"datetime",placeholder:"选择创建时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",clearable:""},null,8,["modelValue"])])),_:1}),_(o,null,{default:s((()=>[_(i,{type:"primary",onClick:z},{default:s((()=>l[16]||(l[16]=[v("搜索")]))),_:1}),_(i,{onClick:E},{default:s((()=>l[17]||(l[17]=[v("重置")]))),_:1})])),_:1})])),_:1},8,["model"])]),p((m(),f(N,{data:g.value,style:{width:"100%"}},{default:s((()=>[_(F,{prop:"rule_id",label:"规则ID",width:"220"}),_(F,{prop:"course_id",label:"课程ID",width:"220"}),_(F,{prop:"course_name",label:"课程名称","min-width":"200"}),_(F,{prop:"ai_product_id",label:"产品ID",width:"220"}),_(F,{prop:"product_name",label:"产品名称","min-width":"200"}),_(F,{prop:"daily_limit",label:"每日限制",width:"100"}),_(F,{prop:"validity_days",label:"有效期(天)",width:"100"}),_(F,{prop:"created_at",label:"创建时间",width:"180"}),_(F,{label:"操作",fixed:"right",width:"200"},{default:s((({row:a})=>[_(K,null,{default:s((()=>[_(i,{type:"primary",link:"",onClick:e=>(e=>{Y.value="edit",R.value=e.rule_id,A.value={course_id:e.course_id,ai_product_id:e.ai_product_id,daily_limit:e.daily_limit,validity_days:e.validity_days},j.value=!0})(a)},{default:s((()=>l[18]||(l[18]=[v("编辑")]))),_:2},1032,["onClick"]),_(i,{type:"danger",link:"",onClick:l=>(async a=>{try{await t.confirm("确定要删除该规则吗？","提示",{type:"warning"}),await e.deleteRule(a.rule_id),d.success("删除成功"),await O()}catch(l){"cancel"!==l&&d.error("删除失败")}})(a)},{default:s((()=>l[19]||(l[19]=[v("删除")]))),_:2},1032,["onClick"])])),_:2},1024)])),_:1})])),_:1},8,["data"])),[[X,C.value]])])),_:1}),_(W,{modelValue:j.value,"onUpdate:modelValue":l[13]||(l[13]=e=>j.value=e),title:"add"===Y.value?"新增规则":"编辑规则",width:"500px"},{footer:s((()=>[n("span",U,[_(i,{onClick:l[12]||(l[12]=e=>j.value=!1)},{default:s((()=>l[20]||(l[20]=[v("取消")]))),_:1}),_(i,{type:"primary",onClick:J},{default:s((()=>l[21]||(l[21]=[v("确定")]))),_:1})])])),default:s((()=>[_(B,{ref_key:"formRef",ref:H,model:A.value,rules:M,"label-width":"100px"},{default:s((()=>["add"===Y.value?(m(),f(o,{key:0,label:"课程",prop:"course_id"},{default:s((()=>[_(T,{modelValue:A.value.course_id,"onUpdate:modelValue":l[8]||(l[8]=e=>A.value.course_id=e),placeholder:"请选择课程",style:{width:"100%"}},{default:s((()=>[(m(!0),r(b,null,V(I.value,(e=>(m(),f(S,{key:e.course_id,label:e.course_name,value:e.course_id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):h("",!0),_(o,{label:"产品",prop:"ai_product_id"},{default:s((()=>[_(T,{modelValue:A.value.ai_product_id,"onUpdate:modelValue":l[9]||(l[9]=e=>A.value.ai_product_id=e),placeholder:"请选择产品",style:{width:"100%"}},{default:s((()=>[(m(!0),r(b,null,V(x.value,(e=>(m(),f(S,{key:e.ai_product_id,label:e.ai_product_name,value:e.ai_product_id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),"edit"===Y.value?(m(),f(o,{key:1,label:"每日限制",prop:"daily_limit"},{default:s((()=>[_(P,{modelValue:A.value.daily_limit,"onUpdate:modelValue":l[10]||(l[10]=e=>A.value.daily_limit=e),min:1,max:100,style:{width:"100%"}},null,8,["modelValue"])])),_:1})):h("",!0),"edit"===Y.value?(m(),f(o,{key:2,label:"有效期",prop:"validity_days"},{default:s((()=>[_(P,{modelValue:A.value.validity_days,"onUpdate:modelValue":l[11]||(l[11]=e=>A.value.validity_days=e),min:1,max:365,style:{width:"100%"}},null,8,["modelValue"])])),_:1})):h("",!0)])),_:1},8,["model"])])),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-7eca00dd"]]);export{I as default};

import{a as e,_ as a}from"./_plugin-vue_export-helper-B34n5pss.js";import{e as l}from"./entitlement-GbjsK_zp.js";import{a as t,c as d}from"./element-plus-C6e0990v.js";import{x as u,r as n,h as i,y as r,P as o,H as s,ag as m,z as p,A as c,I as _,L as v,aq as g,G as y,M as h,J as f,O as b,a6 as V}from"./vue-vendor-B0tYOcBV.js";const w="/api",Y={createEntitlement:a=>e.post(`${w}/user_entitlements`,a),updateEntitlement:(a,l)=>e.patch(`${w}/user_entitlements/${a}`,l),getAllEntitlements:(a=1,l=10)=>e.get(`${w}/user_entitlements?page=${a}&page_size=${l}`),getEntitlement:a=>e.get(`${w}/user_entitlements/${a}`),searchEntitlement:a=>e.post(`${w}/user_entitlements/search`,a),deleteEntitlement:a=>e.delete(`${w}/user_entitlements/${a}`),refreshAllDailyRemaining:()=>e.patch(`${w}/manual_refresh_daily_remaining`)},k={class:"user-entitlement-list"},D={class:"card-header"},U={class:"search-bar"},$={class:"pagination"},C={class:"dialog-footer"},H=a(u({__name:"UserEntitlementList",setup(e){const a=n([]),u=n([]),w=n(!1),H=n(!1),M=n("add"),E=n(""),x=n(1),z=n(10),j=n(0),I=n({entitlement_id:"",phone:"",rule_id:"",course_name:"",product_name:"",start_date:"",end_date:"",daily_remaining:void 0}),A=n(),q=n({phone:"",rule_id:"",end_date:"",daily_remaining:void 0}),O={phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}],rule_id:[{required:!0,message:"请选择规则",trigger:"change"}],end_date:[{required:!0,message:"请选择结束时间",trigger:"change"}],daily_remaining:[{required:!0,message:"请输入剩余次数",trigger:"change"}]},R=async()=>{try{w.value=!0;const e=await Y.getAllEntitlements(x.value,z.value);a.value=e.data.data.items,j.value=e.data.data.total}catch(e){t.error("获取用户权益列表失败")}finally{w.value=!1}},P=async()=>{try{const e=await l.getAllRules();u.value=e.data.data}catch(e){t.error("获取规则列表失败")}},L=async()=>{try{w.value=!0;const e=Object.entries(I.value).reduce(((e,[a,l])=>(""!==l&&null!=l&&(e[a]=l),e)),{});if(0===Object.keys(e).length)return void(await R());const l=await Y.searchEntitlement(e);200===l.data.code?(a.value=l.data.data.items,j.value=l.data.data.total,x.value=l.data.data.page,z.value=l.data.data.page_size):t.error(l.data.message||"搜索失败")}catch(e){t.error("搜索用户权益失败")}finally{w.value=!1}},S=()=>{I.value={entitlement_id:"",phone:"",rule_id:"",course_name:"",product_name:"",start_date:"",end_date:"",daily_remaining:void 0},x.value=1,z.value=10,R()},G=async e=>{x.value=e,Object.keys(I.value).some((e=>I.value[e]))?await L():await R()},J=async e=>{z.value=e,x.value=1,Object.keys(I.value).some((e=>I.value[e]))?await L():await R()},N=()=>{M.value="add",q.value={phone:"",rule_id:""},H.value=!0},B=async()=>{A.value&&await A.value.validate((async e=>{if(e)try{if("add"===M.value)await Y.createEntitlement(q.value),t.success("创建成功");else{const e={end_date:q.value.end_date,daily_remaining:Number(q.value.daily_remaining)};await Y.updateEntitlement(E.value,e),t.success("更新成功")}H.value=!1,await R()}catch(a){t.error("add"===M.value?"创建失败":"更新失败")}}))},F=async()=>{try{w.value=!0;const e=await Y.refreshAllDailyRemaining();200===e.data.code?(t.success("刷新成功"),await R()):t.error(e.data.message||"刷新失败")}catch(e){t.error("刷新失败")}finally{w.value=!1}};return i((async()=>{await Promise.all([R(),P()])})),(e,l)=>{const n=m("el-button"),i=m("el-input"),P=m("el-form-item"),K=m("el-date-picker"),Q=m("el-input-number"),T=m("el-form"),W=m("el-table-column"),X=m("el-tag"),Z=m("el-button-group"),ee=m("el-table"),ae=m("el-pagination"),le=m("el-card"),te=m("el-option"),de=m("el-select"),ue=m("el-dialog"),ne=g("loading");return p(),r("div",k,[o(le,null,{header:s((()=>[c("div",D,[l[18]||(l[18]=c("span",null,"用户权益管理",-1)),o(n,{type:"primary",onClick:N},{default:s((()=>l[16]||(l[16]=[v("新增权益")]))),_:1}),o(n,{type:"success",onClick:F,style:{"margin-left":"10px"}},{default:s((()=>l[17]||(l[17]=[v("刷新所有权益额度")]))),_:1})])])),default:s((()=>[c("div",U,[o(T,{inline:!0,model:I.value,class:"search-form"},{default:s((()=>[o(P,{label:"权益ID"},{default:s((()=>[o(i,{modelValue:I.value.entitlement_id,"onUpdate:modelValue":l[0]||(l[0]=e=>I.value.entitlement_id=e),placeholder:"请输入权益ID",clearable:""},null,8,["modelValue"])])),_:1}),o(P,{label:"手机号"},{default:s((()=>[o(i,{modelValue:I.value.phone,"onUpdate:modelValue":l[1]||(l[1]=e=>I.value.phone=e),placeholder:"请输入手机号",clearable:""},null,8,["modelValue"])])),_:1}),o(P,{label:"规则ID"},{default:s((()=>[o(i,{modelValue:I.value.rule_id,"onUpdate:modelValue":l[2]||(l[2]=e=>I.value.rule_id=e),placeholder:"请输入规则ID",clearable:""},null,8,["modelValue"])])),_:1}),o(P,{label:"课程名称"},{default:s((()=>[o(i,{modelValue:I.value.course_name,"onUpdate:modelValue":l[3]||(l[3]=e=>I.value.course_name=e),placeholder:"请输入课程名称",clearable:""},null,8,["modelValue"])])),_:1}),o(P,{label:"产品名称"},{default:s((()=>[o(i,{modelValue:I.value.product_name,"onUpdate:modelValue":l[4]||(l[4]=e=>I.value.product_name=e),placeholder:"请输入产品名称",clearable:""},null,8,["modelValue"])])),_:1}),o(P,{label:"开始时间"},{default:s((()=>[o(K,{modelValue:I.value.start_date,"onUpdate:modelValue":l[5]||(l[5]=e=>I.value.start_date=e),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",clearable:""},null,8,["modelValue"])])),_:1}),o(P,{label:"结束时间"},{default:s((()=>[o(K,{modelValue:I.value.end_date,"onUpdate:modelValue":l[6]||(l[6]=e=>I.value.end_date=e),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",clearable:""},null,8,["modelValue"])])),_:1}),o(P,{label:"剩余次数"},{default:s((()=>[o(Q,{modelValue:I.value.daily_remaining,"onUpdate:modelValue":l[7]||(l[7]=e=>I.value.daily_remaining=e),min:0,max:100,clearable:""},null,8,["modelValue"])])),_:1}),o(P,null,{default:s((()=>[o(n,{type:"primary",onClick:L},{default:s((()=>l[19]||(l[19]=[v("搜索")]))),_:1}),o(n,{onClick:S},{default:s((()=>l[20]||(l[20]=[v("重置")]))),_:1})])),_:1})])),_:1},8,["model"])]),_((p(),y(ee,{data:a.value,style:{width:"100%"}},{default:s((()=>[o(W,{prop:"entitlement_id",label:"权益ID",width:"220"}),o(W,{prop:"phone",label:"手机号",width:"120"}),o(W,{prop:"rule_id",label:"规则ID",width:"220"}),o(W,{prop:"course_name",label:"课程名称","min-width":"200"}),o(W,{prop:"product_name",label:"产品名称","min-width":"200"}),o(W,{prop:"start_date",label:"开始时间",width:"180"}),o(W,{prop:"end_date",label:"结束时间",width:"180"}),o(W,{prop:"daily_remaining",label:"剩余次数",width:"100"}),o(W,{prop:"is_active",label:"状态",width:"100"},{default:s((({row:e})=>[o(X,{type:e.is_active?"success":"info"},{default:s((()=>[v(h(e.is_active?"有效":"无效"),1)])),_:2},1032,["type"])])),_:1}),o(W,{label:"操作",fixed:"right",width:"200"},{default:s((({row:e})=>[o(Z,null,{default:s((()=>[o(n,{type:"primary",link:"",onClick:a=>(e=>{M.value="edit",E.value=e.entitlement_id,q.value={phone:e.phone,rule_id:e.rule_id,end_date:e.end_date,daily_remaining:e.daily_remaining},H.value=!0})(e)},{default:s((()=>l[21]||(l[21]=[v("编辑")]))),_:2},1032,["onClick"]),o(n,{type:"danger",link:"",onClick:a=>(async e=>{try{await d.confirm("确定要删除该权益吗？","提示",{type:"warning"}),await Y.deleteEntitlement(e.entitlement_id),t.success("删除成功"),await R()}catch(a){"cancel"!==a&&t.error("删除失败")}})(e)},{default:s((()=>l[22]||(l[22]=[v("删除")]))),_:2},1032,["onClick"])])),_:2},1024)])),_:1})])),_:1},8,["data"])),[[ne,w.value]]),c("div",$,[o(ae,{"current-page":x.value,"onUpdate:currentPage":l[8]||(l[8]=e=>x.value=e),"page-size":z.value,"onUpdate:pageSize":l[9]||(l[9]=e=>z.value=e),"page-sizes":[10,20,50,100],total:j.value,layout:"total, sizes, prev, pager, next",onSizeChange:J,onCurrentChange:G},null,8,["current-page","page-size","total"])])])),_:1}),o(ue,{modelValue:H.value,"onUpdate:modelValue":l[15]||(l[15]=e=>H.value=e),title:"add"===M.value?"新增权益":"编辑权益",width:"500px"},{footer:s((()=>[c("span",C,[o(n,{onClick:l[14]||(l[14]=e=>H.value=!1)},{default:s((()=>l[23]||(l[23]=[v("取消")]))),_:1}),o(n,{type:"primary",onClick:B},{default:s((()=>l[24]||(l[24]=[v("确定")]))),_:1})])])),default:s((()=>[o(T,{ref_key:"formRef",ref:A,model:q.value,rules:O,"label-width":"100px"},{default:s((()=>["add"===M.value?(p(),y(P,{key:0,label:"手机号",prop:"phone"},{default:s((()=>[o(i,{modelValue:q.value.phone,"onUpdate:modelValue":l[10]||(l[10]=e=>q.value.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1})):f("",!0),"add"===M.value?(p(),y(P,{key:1,label:"规则",prop:"rule_id"},{default:s((()=>[o(de,{modelValue:q.value.rule_id,"onUpdate:modelValue":l[11]||(l[11]=e=>q.value.rule_id=e),placeholder:"请选择规则",style:{width:"100%"}},{default:s((()=>[(p(!0),r(b,null,V(u.value,(e=>(p(),y(te,{key:e.rule_id,label:`${e.course_name} - ${e.product_name}`,value:e.rule_id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):f("",!0),"edit"===M.value?(p(),y(P,{key:2,label:"结束时间",prop:"end_date"},{default:s((()=>[o(K,{modelValue:q.value.end_date,"onUpdate:modelValue":l[12]||(l[12]=e=>q.value.end_date=e),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue"])])),_:1})):f("",!0),"edit"===M.value?(p(),y(P,{key:3,label:"剩余次数",prop:"daily_remaining"},{default:s((()=>[o(Q,{modelValue:q.value.daily_remaining,"onUpdate:modelValue":l[13]||(l[13]=e=>q.value.daily_remaining=e),min:0,max:100,style:{width:"100%"}},null,8,["modelValue"])])),_:1})):f("",!0)])),_:1},8,["model"])])),_:1},8,["modelValue","title"])])}}}),[["__scopeId","data-v-ab83dd87"]]);export{H as default};
